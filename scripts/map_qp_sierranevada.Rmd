---
title: "Untitled"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library('flexdashboard')
```


```{r}
library("rgdal")
library("sp")
library("raster")
library("leaflet")
library("dplyr")
```

```{r} 
### --- Read limits of Sierra Nevada Protected area
myurl <- 'https://www.dropbox.com/s/phuz9yxyiow78dt/eennpp_ed50_30.zip?dl=0'
# EPSG:23030

# Idea based on http://thebiobucket.blogspot.com.es/2013/09/batch-downloading-zipped-shapefiles.html 
wd <- getwd()
td <- tempdir()
setwd(td)

temp <- tempfile(fileext = ".zip")
download.file(myurl, temp)
unzip(temp)

shp <- dir(tempdir(), "*.shp$")

enp <- readOGR(dsn=shp, layer= sub(".shp$", "", shp), encoding="UTF-8")
unlink(dir(td))
file.remove(list.files(tempdir()))
setwd(wd)
### ---- 

### --- Read distribution of Q. pyrenaica forests
myurl <- 'https://rawgit.com/ajpelu/modis_iv/master/data_raw/geoinfo/quercus_pyrenaica_sn.zip'

# Idea based on http://thebiobucket.blogspot.com.es/2013/09/batch-downloading-zipped-shapefiles.html 
wd <- getwd()
td <- tempdir()
setwd(td)

temp <- tempfile(fileext = ".zip")
download.file(myurl, temp)
unzip(temp)

shp <- dir(tempdir(), "*.shp$")

qp <- readOGR(dsn=shp, layer= sub(".shp$", "", shp), encoding="UTF-8")
unlink(dir(td))
setwd(wd)
### ----

### Prepare Spatial data 
# Sierra Nevada limits 
enp_r <- spTransform(enp, CRS("+init=epsg:4326"))

# Select Sierra Nevada 
sn <- subset(enp_r, NOMBRE == 'SIERRA NEVADA' & FIGURA == 'Espacio Natural')
sn_nat <- subset(enp_r, NOMBRE == 'SIERRA NEVADA' & FIGURA == 'Parque Nacional')

# Pyrenean forests 
qp_r <- spTransform(qp, CRS("+init=epsg:4326"))
```

Column 
-----------------------------------------------------------------------

### Map
```{r}
# Identificador poblaciones
popup_qp <- paste0("<strong>Name:</strong> ", qp_r$LOCALIDAD,
                   "<br><strong>Valley:</strong> ", qp_r$VALLE)

# Extension capa robledales
ext_qp <- extent(qp_r)

# Map 
m <- leaflet() %>% 
  # Fit map
  fitBounds(ext_qp@xmin, ext_qp@ymin, ext_qp@xmax, ext_qp@ymax) %>% 
  
  # Basemaps
  addWMSTiles('http://www.ideandalucia.es/services/toporaster10/wms?',
              layers = 'toporaster10',
              options = WMSTileOptions(format = "image/png", transparent = FALSE),
              attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>', 
              group = 'Topographical') %>%
  addProviderTiles("Esri.WorldImagery", 
                   group='Satellite') %>% 
  addWMSTiles('http://www.ideandalucia.es/wms/mdt_2005?',
              layers = 'Sombreado_10',
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>', 
              group = 'Hillshade') %>% 
  
  # Polygons 
  addPolygons(data = qp_r, 
              group= 'Q. pyrenaica forests',
              fillColor = '#d94801', fillOpacity = 0.6, stroke = FALSE,
              popup = popup_qp) %>% 
  addPolygons(data = sn, 
              group = 'Natural Protected Area',
              fill=FALSE, color = 'blue', weight=2.5) %>% 

    # Layers control
  addLayersControl(position = 'bottomright',
                   baseGroups = c("Hillshade", "Satellite", "Topographical"),
                   overlayGroups = c('Natural Protected Area', 'Q. pyrenaica forests'),
                   options = layersControlOptions(collapsed = TRUE))
```

